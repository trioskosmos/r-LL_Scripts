<!DOCTYPE html>
<html>
  <head>
    <style>
      body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        background: #121212; 
        color: #fff; 
        margin: 0; padding: 0;
        height: 100vh;
        display: flex; flex-direction: column;
        user-select: none; /* Prevents text highlighting on fast clicks */
      }

      header {
        height: 40px;
        padding: 0 15px;
        background: #000;
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid #333;
      }
      .status { font-size: 11px; color: #666; font-family: monospace; }
      .ctrl-btn {
        background: transparent; color: #888; border: 1px solid #444;
        padding: 4px 12px; border-radius: 20px; cursor: pointer; font-size: 11px;
      }
      .ctrl-btn:hover { border-color: #fff; color: #fff; }

      /* Split Screen Layout */
      #arena {
        flex-grow: 1;
        display: flex;
        width: 100%;
      }

      .fighter {
        flex: 1;
        display: flex;
        align-items: center; justify-content: center;
        position: relative;
        cursor: pointer;
        transition: background 0.1s;
      }
      
      /* Colors */
      #left-side { background: #1a1a1a; border-right: 1px solid #333; }
      #right-side { background: #1a1a1a; }

      #left-side:hover { background: #252525; }
      #right-side:hover { background: #252525; }
      
      #left-side:active { background: #1DB954; color: #000; }
      #right-side:active { background: #1DB954; color: #000; }

      .song-text {
        font-size: 24px;
        font-weight: 700;
        padding: 20px;
        text-align: center;
        pointer-events: none; /* Clicks pass through to the div */
      }

      #overlay {
        position: absolute; top:0; left:0; width:100%; height:100%;
        background: #121212; z-index: 100;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
      }
      .hidden { display: none !important; }

    </style>
  </head>
  <body>

    <header>
      <div class="status">
        <span id="save-status">Synced</span>
      </div>
      <div>
        <button class="ctrl-btn" onclick="undo()">Undo</button>
        <button class="ctrl-btn" onclick="reset()">Reset</button>
      </div>
    </header>

    <div id="overlay">
      <h1>Loading...</h1>
    </div>

    <div id="arena" class="hidden">
      <!-- Left Giant Button -->
      <div class="fighter" id="left-side" onclick="pick('left')">
        <div class="song-text" id="txt-left">Song A</div>
      </div>
      
      <!-- Right Giant Button -->
      <div class="fighter" id="right-side" onclick="pick('right')">
        <div class="song-text" id="txt-right">Song B</div>
      </div>
    </div>

    <script>
      let S = null;
      let saveTimer = null;

      function init() {
        google.script.run
          .withSuccessHandler(state => {
            S = state;
            processNextPair();
          })
          .withFailureHandler(e => document.getElementById('overlay').innerText = "Error: " + e)
          .getInitialData();
      }

      function pick(side) {
        // 1. History
        S.history.push(JSON.stringify({
          queue: S.queue,
          leftArr: S.leftArr,
          rightArr: S.rightArr,
          merged: S.merged
        }));
        if (S.history.length > 5) S.history.shift();

        // 2. Logic
        if (side === 'left') S.merged.push(S.leftArr.shift());
        else S.merged.push(S.rightArr.shift());

        // 3. Render
        processNextPair();
        
        // 4. Background Save
        triggerSave();
      }

      function processNextPair() {
        if (S.leftArr.length === 0 && S.rightArr.length === 0) {
          if (S.merged.length > 0) {
            S.queue.push(S.merged);
            S.merged = [];
          }
          if (S.queue.length === 1) {
            S.status = 'FINISHED';
            finishGame();
            google.script.run.saveFinalResult(S.userId, S.songList, S.queue[0]);
            return;
          }
          S.leftArr = S.queue.shift();
          S.rightArr = S.queue.shift();
        }

        renderUI();
      }

      function renderUI() {
        document.getElementById('overlay').classList.add('hidden');
        document.getElementById('arena').classList.remove('hidden');

        // DIRECT TEXT UPDATE - No lag, no iframes
        document.getElementById('txt-left').innerText = S.songList[S.leftArr[0]].name;
        document.getElementById('txt-right').innerText = S.songList[S.rightArr[0]].name;
      }

      function finishGame() {
        document.getElementById('arena').classList.add('hidden');
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('overlay').innerHTML = `
          <h1 style="color:#1DB954; font-size:48px;">Done!</h1>
          <p>Results saved to spreadsheet.</p>
        `;
      }

      function undo() {
        if (!S.history.length) return;
        const last = JSON.parse(S.history.pop());
        Object.assign(S, last);
        renderUI();
        triggerSave();
      }

      function reset() {
        if(!confirm("Reset everything?")) return;
        S.queue = S.songList.map((_, i) => [i]);
        S.leftArr = [];
        S.rightArr = [];
        S.merged = [];
        S.history = [];
        processNextPair();
        triggerSave();
      }
      function triggerSave() {
        const el = document.getElementById('save-status');
        el.innerText = "Unsaved...";
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          el.innerText = "Saving...";
          google.script.run
            .withSuccessHandler(() => el.innerText = "Synced")
            .backgroundSave(JSON.stringify(S));
        }, 3000);
      }

      init();
    </script>
  </body>
</html>